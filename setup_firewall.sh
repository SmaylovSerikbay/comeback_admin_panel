#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ firewall –¥–ª—è Comeback Admin Panel
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç UFW –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ VDS

set -e

echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall –¥–ª—è Comeback Admin Panel..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã root
if [[ $EUID -ne 0 ]]; then
   echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
   exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UFW –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v ufw &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UFW..."
    apt update -y
    apt install -y ufw
fi

# –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞
echo "üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞ firewall..."
ufw --force reset

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
echo "‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é..."
ufw default deny incoming
ufw default allow outgoing

# –†–∞–∑—Ä–µ—à–∞–µ–º SSH (–ø–æ—Ä—Ç 22)
echo "üîë –†–∞–∑—Ä–µ—à–∞–µ–º SSH (–ø–æ—Ä—Ç 22)..."
ufw allow 22/tcp

# –†–∞–∑—Ä–µ—à–∞–µ–º HTTP (–ø–æ—Ä—Ç 80)
echo "üåê –†–∞–∑—Ä–µ—à–∞–µ–º HTTP (–ø–æ—Ä—Ç 80)..."
ufw allow 80/tcp

# –†–∞–∑—Ä–µ—à–∞–µ–º HTTPS (–ø–æ—Ä—Ç 443)
echo "üîí –†–∞–∑—Ä–µ—à–∞–µ–º HTTPS (–ø–æ—Ä—Ç 443)..."
ufw allow 443/tcp

# –†–∞–∑—Ä–µ—à–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
echo "üè† –†–∞–∑—Ä–µ—à–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
ufw allow from 127.0.0.1
ufw allow from ::1

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
read -p "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üîß –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã..."
    ufw allow 8000/tcp  # Django development
    ufw allow 5432/tcp  # PostgreSQL
    ufw allow 6379/tcp  # Redis
fi

# –í–∫–ª—é—á–∞–µ–º firewall
echo "üöÄ –í–∫–ª—é—á–∞–µ–º firewall..."
ufw --force enable

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å firewall:"
ufw status verbose

echo ""
echo "‚úÖ Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≤–∫–ª—é—á–µ–Ω!"
echo ""
echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   –°—Ç–∞—Ç—É—Å: ufw status"
echo "   –ü—Ä–∞–≤–∏–ª–∞: ufw status numbered"
echo "   –û—Ç–∫–ª—é—á–∏—Ç—å: ufw disable"
echo "   –í–∫–ª—é—á–∏—Ç—å: ufw enable"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSH –¥–æ—Å—Ç—É–ø–µ–Ω –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å–µ—Å—Å–∏–∏!"
echo ""
