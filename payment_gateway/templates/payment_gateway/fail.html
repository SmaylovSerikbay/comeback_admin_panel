{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-times-circle"></i> –ü–ª–∞—Ç–µ–∂ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω
                    </h3>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="text-danger mb-3">–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª</h4>
                    <p class="lead">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞.</p>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏.</p>
                    
                    <!-- üîó Deep Link –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ Unity -->
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-mobile-alt"></i>
                        <strong>–í–æ–∑–≤—Ä–∞—Ç –≤ Unity:</strong> 
                        <span id="countdown">3</span> —Å–µ–∫—É–Ω–¥—ã –¥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞...
                    </div>
                    
                    <div class="mt-4">
                        <button id="returnToUnityBtn" class="btn btn-warning btn-lg">
                            <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ Unity
                        </button>
                        <a href="{% url 'payment_gateway:test_form' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </a>
                        <a href="{% url 'payment_gateway:dashboard' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-chart-bar"></i> –î–∞—à–±–æ—Ä–¥
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// üîó Deep Link –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ Unity
const orderId = '{{ request.GET.pg_order_id }}';
const deepLinkScheme = 'comebackar';
const deepLinkHost = 'payment';

function createDeepLink() {
    return `${deepLinkScheme}://${deepLinkHost}?order_id=${orderId}&status=payment_failed`;
}

function returnToUnity() {
    const deepLink = createDeepLink();
    console.log('üîó –í–æ–∑–≤—Ä–∞—Ç –≤ Unity —á–µ—Ä–µ–∑ deep link:', deepLink);
    
    try {
        // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å deep link
        window.location.href = deepLink;
        
        // Fallback: –µ—Å–ª–∏ deep link –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        setTimeout(() => {
            document.getElementById('returnToUnityBtn').innerHTML = 
                '<i class="fas fa-copy"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è Unity';
            document.getElementById('returnToUnityBtn').onclick = () => {
                navigator.clipboard.writeText(deepLink);
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –í—Å—Ç–∞–≤—å—Ç–µ –µ—ë –≤ Unity –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞.');
            };
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ Unity:', error);
        alert('–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ Unity. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é.');
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
let countdown = 3;
const countdownElement = document.getElementById('countdown');

const timer = setInterval(() => {
    countdown--;
    countdownElement.textContent = countdown;
    
    if (countdown <= 0) {
        clearInterval(timer);
        returnToUnity();
    }
}, 1000);

// –ö–Ω–æ–ø–∫–∞ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞
document.getElementById('returnToUnityBtn').onclick = returnToUnity;

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—É–ª—Å—è –≤ Unity)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('üîó –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞ - –≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—É–ª—Å—è –≤ Unity');
        clearInterval(timer);
    }
});
</script>
{% endblock %}
