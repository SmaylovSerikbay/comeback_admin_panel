{% extends 'base.html' %}

{% block title %}Дашборд - ComeBack Admin{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.today.successful }}</h4>
                        <p class="card-text text-white">Платежей сегодня</p>
                    </div>
                    <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                </div>
                <small class="text-white">Доход: {{ stats.today.revenue }} сум</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.week.successful }}</h4>
                        <p class="card-text text-white">За неделю</p>
                    </div>
                    <i class="fas fa-calendar-week fa-2x opacity-75"></i>
                </div>
                <small class="text-white">Доход: {{ stats.week.revenue }} сум</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.month.successful }}</h4>
                        <p class="card-text text-white">За месяц</p>
                    </div>
                    <i class="fas fa-calendar-alt fa-2x opacity-75"></i>
                </div>
                <small class="text-white">Доход: {{ stats.month.revenue }} сум</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.all_time.successful }}</h4>
                        <p class="card-text text-white">Всего платежей</p>
                    </div>
                    <i class="fas fa-infinity fa-2x opacity-75"></i>
                </div>
                <small class="text-white">Общий доход: {{ stats.all_time.revenue }} сум</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>Быстрые действия
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if user_role == 'admin' %}
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'videos:create' %}" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-2"></i>Добавить видео
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'videos:instructions' %}" class="btn btn-info w-100">
                            <i class="fas fa-question-circle me-2"></i>Инструкции
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'dashboard:statistics' %}" class="btn btn-success w-100">
                            <i class="fas fa-chart-bar me-2"></i>Статистика
                        </a>
                    </div>
                    {% endif %}
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'dashboard:payments' %}" class="btn btn-secondary w-100">
                            <i class="fas fa-list me-2"></i>Все платежи
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase Status -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fab fa-google me-2"></i>Статус Firebase
                </h5>
            </div>
            <div class="card-body">
                {% if firebase_status.status == 'connected' %}
                    <div class="alert alert-success mb-0">
                        <i class="fas fa-check-circle me-2"></i>{{ firebase_status.message }}
                    </div>
                {% elif firebase_status.status == 'warning' %}
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>{{ firebase_status.message }}
                        <br><small class="mt-2 d-block">
                            Система работает без Firebase. Для полной функциональности настройте Firebase ключи в .env файле.
                        </small>
                    </div>
                {% else %}
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-times-circle me-2"></i>{{ firebase_status.message }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Payments -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-credit-card me-2"></i>Последние платежи
                </h5>
                <a href="{% url 'dashboard:payments' %}" class="btn btn-sm btn-outline-primary">
                    Все платежи <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="card-body p-0">
                {% if recent_payments %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID заказа</th>
                                <th>Сумма</th>
                                <th>Статус</th>
                                <th>Дата</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>
                                    <code>{{ payment.order_id|truncatechars:20 }}</code>
                                </td>
                                <td>
                                    <strong>{{ payment.amount }} {{ payment.currency }}</strong>
                                </td>
                                <td>
                                    {% if payment.status == 'success' %}
                                        <span class="badge bg-success">{{ payment.get_status_display }}</span>
                                    {% elif payment.status == 'pending' %}
                                        <span class="badge bg-warning">{{ payment.get_status_display }}</span>
                                    {% elif payment.status == 'failed' %}
                                        <span class="badge bg-danger">{{ payment.get_status_display }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ payment.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ payment.created_at|date:"d.m.Y H:i" }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Платежей пока нет</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if user_role == 'admin' and daily_stats %}
<!-- Daily Revenue Chart -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Доходы за последнюю неделю
                </h5>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if user_role == 'admin' and daily_stats %}
<script>
// Revenue Chart
const ctx = document.getElementById('revenueChart').getContext('2d');
const revenueChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for stat in daily_stats %}'{{ stat.date|date:"d.m" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Доход (сум)',
            data: [{% for stat in daily_stats %}{{ stat.total_revenue }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
